<!-- sender.html -->

<!DOCTYPE html>
<html>
  <body>
    <h2>Sender (Webcam PC)</h2>
    <video id="localVideo" autoplay playsinline muted style="width: 100%; height: auto;"></video>

    <script>
      const ws = new WebSocket("wss://161.3.140.22:8443");
    //   const ws = new WebSocket("wss://161.3.140.22:3000");

      ws.onopen = () => ws.send(JSON.stringify({ role: "sender" }));

      const pc = new RTCPeerConnection();
      const video = document.getElementById("localVideo");

      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
          stream.getTracks().forEach(track => pc.addTrack(track, stream));
          return pc.createOffer();
        })
        .then(offer => {
          pc.setLocalDescription(offer);
          ws.send(JSON.stringify({ role: "sender", type: "offer", sdp: offer.sdp }));
        });

      pc.onicecandidate = e => {
        if (e.candidate) {
          ws.send(JSON.stringify({ role: "sender", candidate: e.candidate }));
        }
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "answer") {
          await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
        } else if (data.candidate) {
          pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      };
    </script>
  </body>
</html>
