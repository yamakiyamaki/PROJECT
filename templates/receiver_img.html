<!DOCTYPE html>
<html>

<body>
  <h2>Receiver</h2>
  <!-- <video id="remoteVideo" autoplay playsinline muted style="width: auto; height: 50%;"></video> -->
  <video id="remoteVideo" playsinline muted controls></video>
  <button onclick="video.play()">Play Video</button>


  <div id="log"
    style="white-space: pre-wrap; font-size: 14px; max-height: 50%; overflow-y: auto; background: #eee; padding: 10px; border-radius: 5px;">
  </div>

  <script>
    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += `\n${new Date().toLocaleTimeString()} - ${msg}`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg); // still useful on desktop
    }
  </script>

  <script>
    log("Connecting to WebSocket...");
    const ws = new WebSocket("wss://161.3.140.22:9000");

    ws.onopen = () => {
      log("WebSocket connected ‚úÖ");
      ws.send(JSON.stringify({ role: "receiver" }));
    };

    ws.onerror = (e) => {
      log("WebSocket ERROR ‚ùå");
    };

    ws.onclose = () => {
      log("WebSocket closed üîå");
    };

    // const pc = new RTCPeerConnection({
    //   iceServers: [
    //     { urls: "stun:stun.l.google.com:19302" }
    //   ]
    // });
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:openrelay.metered.ca:443",
          username: "openrelayproject",
          credential: "openrelayproject"
        }
      ],
      iceTransportPolicy: "relay"
    });


    const video = document.getElementById("remoteVideo");

    // pc.ontrack = (event) => {
    //   log("Received media track üé•");
    //   video.srcObject = event.streams[0];
    // };

    // pc.ontrack = (event) => {
    //   log("Received media track üé•");
    //   video.srcObject = event.streams[0];
    //   video.play().then(() => log("Video playing ‚úÖ")).catch(e => log("Video play failed ‚ùå: " + e));
    // };
    pc.ontrack = (event) => {
      log("Received media track üé•");
      video.srcObject = event.streams[0];
      video.play()
        .then(() => log("Video playing ‚úÖ"))
        .catch((e) => log("Video play failed ‚ùå: " + e));
    };



    pc.onicecandidate = e => {
      if (e.candidate) {
        log("Sending ICE candidate ‚ùÑÔ∏è");
        ws.send(JSON.stringify({ role: "receiver", candidate: e.candidate }));
      } else {
        log("All ICE candidates sent ‚úÖ");
      }
    };

    pc.oniceconnectionstatechange = () => {
      log("ICE connection state: " + pc.iceConnectionState);
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "offer") {
        log("Received offer üì©");
        await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });
        log("Set remote description ‚úÖ");

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        log("Created and set local answer ‚úÖ");

        ws.send(JSON.stringify({ role: "receiver", type: "answer", sdp: answer.sdp }));
        log("Sent answer back to sender üì§");

      } else if (data.candidate) {
        log("Received ICE candidate ‚ùÑÔ∏è");
        pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };
  </script>
</body>

</html>