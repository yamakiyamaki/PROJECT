<!DOCTYPE html>
<html>

<body>
  <h2>Sender (Canvas Stream)</h2>
  <video id="localVideo" autoplay playsinline muted style="width: 100%; height: auto;"></video>

  <script>
    const ws = new WebSocket("wss://161.3.140.22:9000");

    ws.onopen = () => {
      console.log("WebSocket connected âœ…");
      ws.send(JSON.stringify({ role: "sender" }));
      startStreaming();
    };

    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:openrelay.metered.ca:443",
          username: "openrelayproject",
          credential: "openrelayproject"
        }
      ],
      iceTransportPolicy: "relay"
    });

    pc.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ role: "sender", candidate: e.candidate }));
      }
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "answer") {
        await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
        console.log("Remote description set âœ…");
      } else if (data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        console.log("Added ICE candidate â„ï¸");
      }
    };

    function startStreaming() {
      const canvas = document.createElement("canvas");
      canvas.width = 640;
      canvas.height = 480;
      const ctx = canvas.getContext("2d");

      // Draw a simple image
      ctx.fillStyle = "#00ccff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "30px sans-serif";
      ctx.fillText("ðŸ“¡ Hello from Canvas!", 100, 100);

      const stream = canvas.captureStream(5); // 5 fps
      document.getElementById("localVideo").srcObject = stream;

      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      pc.createOffer()
        .then(offer => pc.setLocalDescription(offer))
        .then(() => {
          ws.send(JSON.stringify({ role: "sender", type: "offer", sdp: pc.localDescription.sdp }));
          console.log("SDP offer sent ðŸ“¤");
        });
    }
  </script>
</body>

</html>
